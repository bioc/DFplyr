---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```
# DFplyr

<!-- badges: start -->
<!-- badges: end -->

The goal of DFplyr is to enable `dplyr` and `ggplot2` support for `S4Vectors::DataFrame` by 
providing the appropriate extension methods. As row names are an important feature of many 
Bioconductor structures, these are preserved where possible.

## Installation

You can install the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("jonocarroll/DFplyr")
```
## Examples

Most `dplyr` functions are implemented. If you find any which are not, please [file an issue](https://github.com/jonocarroll/DFplyr/issues/new).

```{r}
suppressPackageStartupMessages(
  suppressWarnings({
    library(S4Vectors)
    library(dplyr)
    library(DFplyr)
  }))
```

First create an S4Vectors DataFrame

```{r}
m <- mtcars[, c("cyl", "hp", "am", "gear", "disp")]
d <- as(m, "DataFrame")
d
```

This will appear in RStudio's environment pane as a `Formal class DataFrame (dplyr-compatible)` when 
using `DFplyr`. No interference with the actual object is required, but this helps 
identify that `dplyr`-compatibility is available.

`DataFrame`s can then be used in `dplyr` calls the same as `data.frame` or `tibble` objects

```{r}
mutate(d, newvar = cyl + hp)
```

This includes piped calls with `%>%`


```{r}
mutate(d, newvar = cyl + hp) %>%
  pull(newvar)
```

and `tidyselect` helpers.

```{r}
mutate_at(d, vars(starts_with("c")), ~.^2)
```

Importantly, grouped operations are supported. `DataFrame` does not 
natively support groups (the same way that `data.frame` does not) so these
are implemented specifically for `DFplyr`

```{r}
group_by(d, cyl, am)

group_by(d, cyl) %>% 
  top_n(1, disp)
```

Other verbs are similiarly implemented, and preserve row names where possible

```{r}
select(d, am, cyl)

select(d, am, cyl) %>%
  rename(foo = am)

arrange(d, desc(hp))

filter(d, am == 0) 

slice(d, 3:6)

dd <- rbind(data.frame(m[1, ], row.names = "MyCar"), d)
dd
```

Row names are not preserved when there may be duplicates 

```{r}
distinct(dd)

group_by(d, cyl, am) %>%
  tally(gear)

count(d, gear, am, cyl)
```

`ggplot2` support is also enabled

```{r}
library(ggplot2)
ggplot(d, aes(disp, cyl)) + geom_point()
```

## S4 Columns

Support for S4 columns is preliminary. Printing works, and a `DataFrame` containing them 
may be used in verb operations, but the verbs cannot (currently) act directly on them (via `...`)

```{r}
d2 <- d
library(GenomicRanges)
d2$gr <- GRanges("chrY", IRanges(1:32, width=10))
d2$gr2 <- GRanges("chrX", IRanges(1:32, width = 10))
d2$nl <- NumericList(lapply(d2$cyl, function(n) rnorm(n)))
d2

filter(d2, cyl == 6)

select(d2, cyl:am)

mutate(d2, newcol = rnorm(32))
```

`DataFrame` objects are still useful as the `.data` argument

```{r}
mtcars_desc <- tibble::tribble(
  ~col, ~desc,
  "mpg",	"Miles/(US) gallon",
  "cyl",	"Number of cylinders",
  "disp",	"Displacement (cu.in.)",
  "hp",	"Gross horsepower",
  "drat",	"Rear axle ratio",
  "wt",	"Weight (1000 lbs)",
  "qsec",	"1/4 mile time",
  "vs",	"Engine (0 = V-shaped, 1 = straight)",
  "am",	"Transmission (0 = automatic, 1 = manual)",
  "gear",	"Number of forward gears",
  "carb",	"Number of carburetors"
)
mcols(d) <- mtcars_desc[match(names(d), mtcars_desc$col), "desc"]
mcols(d)

mutate(mcols(d), varname = tools::toTitleCase(desc))
```

## Implementation

Most of the `dplyr` verbs for `DataFrame`s are implmented by first converting to `tibble`, 
performing the verb operation, then converting back to `DataFrame`. Care has been taken to 
retain groups and row names and preserve S4 columns through these operations, but this is fragile and 
may introduce some complications. If you spot any, please [file an issue](https://github.com/jonocarroll/DFplyr/issues/new).
